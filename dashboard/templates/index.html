<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit AI Control Center</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>

<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="brand">
                <span class="material-icons-round logo-icon">smart_toy</span>
                <h2>AI TRADER</h2>
            </div>
            <div class="menu">
                <div class="menu-item active">
                    <span class="material-icons-round">dashboard</span> Panel Principal
                </div>
                <div class="menu-item">
                    <span class="material-icons-round">settings</span> Configuración
                </div>
                <div class="menu-item">
                    <span class="material-icons-round">history</span> Historial
                </div>
            </div>
            <div class="status-box">
                <div id="connection-status" class="status-indicator online">
                    <span class="dot"></span> ONLINE
                </div>
                <div class="server-status">Render Cloud: ACTIVO</div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header Stats -->
            <header class="top-bar">
                <div class="welcome-text">
                    <h1>Panel de Control</h1>
                    <p>Monitoreo en Tiempo Real</p>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-icon btn-start" onclick="startBot()">
                        <span class="material-icons-round">play_arrow</span> INICIAR
                    </button>
                    <button class="btn btn-icon btn-stop" onclick="stopBot()">
                        <span class="material-icons-round">stop</span> DETENER
                    </button>
                </div>
            </header>

            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="card kpi-card glass">
                    <div class="card-icon info-icon"><span class="material-icons-round">account_balance_wallet</span>
                    </div>
                    <div class="card-info">
                        <h3>Balance Total</h3>
                        <div id="balance" class="value">0.00 USDT</div>
                        <span class="sub-text">Cuenta Demo Bybit</span>
                    </div>
                </div>
                <div class="card kpi-card glass">
                    <div class="card-icon success-icon"><span class="material-icons-round">trending_up</span></div>
                    <div class="card-info">
                        <h3>PnL Sesión</h3>
                        <div id="total-pnl" class="value">0.00 USDT</div>
                        <span class="sub-text">Ganancia/Pérdida Neta</span>
                    </div>
                </div>
                <div class="card kpi-card glass">
                    <div class="card-icon warning-icon"><span class="material-icons-round">insights</span></div>
                    <div class="card-info">
                        <h3>Tendencia BTC</h3>
                        <div id="btc-trend" class="value text-sm">ESPERANDO...</div>
                        <span class="sub-text">Sentimiento de Mercado</span>
                    </div>
                </div>
                <div class="card kpi-card glass">
                    <div class="card-icon primary-icon"><span class="material-icons-round">psychology</span></div>
                    <div class="card-info">
                        <h3>Aprendizaje IA</h3>
                        <div id="learning-points" class="value">0 XP</div>
                        <span class="sub-text">Nivel de Inteligencia</span>
                    </div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Live Activity Feed -->
                <div class="card glass large-card">
                    <div class="card-header">
                        <h3><span class="material-icons-round">radar</span> Radar de Mercado</h3>
                        <div id="scanning-status" class="scanning-badge">Escaneando...</div>
                    </div>
                    <div id="logs" class="logs-console">
                        <div class="log-entry log-system">Iniciando sistema de visualización...</div>
                    </div>
                </div>

                <!-- Active Positions -->
                <div class="card glass large-card">
                    <div class="card-header">
                        <h3><span class="material-icons-round">list_alt</span> Operaciones Abiertas</h3>
                        <span id="active-count" class="badge">0</span>
                    </div>
                    <div class="table-responsive">
                        <table class="styled-table">
                            <thead>
                                <tr>
                                    <th>Par</th>
                                    <th>Tipo</th>
                                    <th>Entrada</th>
                                    <th>PnL (USDT)</th>
                                </tr>
                            </thead>
                            <tbody id="positions-body">
                                <tr>
                                    <td colspan="4" class="empty-state">Sin operaciones activas</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Config -->
                <div class="card glass">
                    <div class="card-header">
                        <h3><span class="material-icons-round">tune</span> Ajustes Rápidos</h3>
                    </div>
                    <div class="config-panel">
                        <div class="input-group">
                            <label>Monto Operación (USDT)</label>
                            <input type="number" id="cfg-monto" class="glass-input">
                        </div>
                        <div class="input-group">
                            <label>Apalancamiento (x)</label>
                            <input type="number" id="cfg-leverage" class="glass-input" max="10">
                        </div>
                        <div class="input-group">
                            <label>Max. Operaciones</label>
                            <input type="number" id="cfg-max-ops" class="glass-input" value="5">
                        </div>
                        <div class="input-group">
                            <label>Estrategia (EMA Rápida / Lenta)</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="cfg-ema-fast" class="glass-input" placeholder="8">
                                <input type="number" id="cfg-ema-slow" class="glass-input" placeholder="21">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Periodo RSI</label>
                            <input type="number" id="cfg-rsi" class="glass-input" placeholder="14">
                        </div>
                        <button class="btn btn-primary full-width" onclick="saveConfig()">
                            <span class="material-icons-round">save</span> GUARDAR CAMBIOS
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const socket = io();

        socket.on('connect', () => {
            document.getElementById('connection-status').innerHTML = '<span class="dot"></span> CONECTADO';
            document.getElementById('connection-status').classList.add('online');
            sendSystemLog("Conectado al servidor del bot.");
        });

        socket.on('disconnect', () => {
            document.getElementById('connection-status').innerHTML = '<span class="dot red"></span> DESCONECTADO';
            document.getElementById('connection-status').classList.remove('online');
            sendSystemLog("Conexión perdida. Reintentando...");
        });

        socket.on('update_data', function (data) {
            // Animación de números básica si cambian
            updateText('balance', data.balance + ' USDT');
            updatePnl('total-pnl', data.total_pnl);

            if (data.btc_trend) {
                const el = document.getElementById('btc-trend');
                el.innerText = data.btc_trend;
                el.style.color = data.btc_trend.includes('ALCISTA') ? '#34d399' : (data.btc_trend.includes('BAJISTA') ? '#f87171' : '#fff');
            }

            if (data.points !== undefined) document.getElementById('learning-points').innerText = data.points + " XP";

            if (data.positions) updatePositionsTable(data.positions);
        });

        socket.on('new_log', function (data) {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (data.type || 'log-info');

            const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${data.message}`;

            logsDiv.insertBefore(entry, logsDiv.firstChild);

            if (logsDiv.children.length > 50) logsDiv.removeChild(logsDiv.lastChild);
        });

        function updateText(id, newVal) {
            const el = document.getElementById(id);
            if (el.innerText !== newVal) el.innerText = newVal;
        }

        function updatePnl(id, val) {
            const el = document.getElementById(id);
            const num = parseFloat(val);
            el.innerText = val + ' USDT';
            el.className = 'value ' + (num >= 0 ? 'text-success' : 'text-danger');
        }

        function updatePositionsTable(positions) {
            const body = document.getElementById('positions-body');
            document.getElementById('active-count').innerText = positions.length;

            if (positions.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="empty-state">Sin operaciones activas</td></tr>';
                return;
            }

            body.innerHTML = '';
            positions.forEach(p => {
                const pnl = parseFloat(p.unrealisedPnl || 0);
                const row = `<tr>
                    <td class="font-bold">${p.symbol}</td>
                    <td class="${p.side === 'Buy' ? 'text-success' : 'text-danger'}">${p.side === 'Buy' ? 'LONG' : 'SHORT'}</td>
                    <td>${p.avgPrice}</td>
                    <td class="${pnl >= 0 ? 'text-success' : 'text-danger'} font-bold">${pnl.toFixed(2)}</td>
                </tr>`;
                body.innerHTML += row;
            });
        }

        function sendSystemLog(msg) {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry log-system';
            entry.innerText = `> ${msg}`;
            logsDiv.insertBefore(entry, logsDiv.firstChild);
        }

        function startBot() {
            fetch('/start').then(() => sendSystemLog("Comando INICIAR enviado"));
        }

        function stopBot() {
            fetch('/stop').then(() => sendSystemLog("Comando DETENER enviado"));
        }

        // Cargar Configuración
        fetch('/config').then(r => r.json()).then(config => {
            document.getElementById('cfg-monto').value = config.trading.monto_por_operacion;
            document.getElementById('cfg-leverage').value = config.trading.apalancamiento;
            document.getElementById('cfg-max-ops').value = config.trading.max_operaciones_simultaneas || 5;

            if (config.estrategia) {
                document.getElementById('cfg-ema-fast').value = config.estrategia.ema_rapida;
                document.getElementById('cfg-ema-slow').value = config.estrategia.ema_lenta;
                document.getElementById('cfg-rsi').value = config.estrategia.rsi_periodo;
            }
        });

        function saveConfig() {
            fetch('/config').then(r => r.json()).then(config => {
                config.trading.monto_por_operacion = parseFloat(document.getElementById('cfg-monto').value);
                config.trading.apalancamiento = parseInt(document.getElementById('cfg-leverage').value);
                config.trading.max_operaciones_simultaneas = parseInt(document.getElementById('cfg-max-ops').value);

                // Estrategia
                config.estrategia.ema_rapida = parseInt(document.getElementById('cfg-ema-fast').value);
                config.estrategia.ema_lenta = parseInt(document.getElementById('cfg-ema-slow').value);
                config.estrategia.rsi_periodo = parseInt(document.getElementById('cfg-rsi').value);

                fetch('/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                }).then(() => alert('Configuración guardada.'));
            });
        }
    </script>
</body>

</html>