<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit AI Bot Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">BYBIT AI TRADING BOT</div>
            <div id="status" class="status-badge status-online">
                <span class="dot"></span> SISTEMA ACTIVO
            </div>
        </header>

        <!-- Fila 1: Métricas Principales -->
        <div class="grid">
            <div class="card">
                <div class="card-title">Balance Actual</div>
                <div id="balance" class="card-value">0.00 USDT</div>
                <div class="card-footer" style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">Disponible en Bybit</div>
            </div>
            <div class="card">
                <div class="card-title">PnL Total (Sesión)</div>
                <div id="total-pnl" class="card-value">0.00 USDT</div>
            </div>
            <div class="card">
                <div class="card-title">Estado Bitcoin</div>
                <div id="btc-trend" class="card-value">---</div>
                <div id="btc-detail" style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">Jefe del Mercado</div>
            </div>
        </div>

        <!-- Fila 2: Estadísticas de Inteligencia y Rendimiento -->
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));">
            <div class="card stat-card">
                <div class="card-title">Efectividad (Win Rate)</div>
                <div id="win-rate" class="card-value" style="color: var(--info);">0%</div>
                <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">
                    <span id="win-count" style="color: var(--success);">0 W</span> / 
                    <span id="loss-count" style="color: var(--danger);">0 L</span>
                </div>
            </div>
            <div class="card stat-card">
                <div class="card-title">Ranking de Aprendizaje</div>
                <div id="learning-points" class="card-value" style="color: var(--primary);">0</div>
                <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">Módulo 8: IA Ligera</div>
            </div>
            <div class="card stat-card">
                <div class="card-title">Monedas Analizadas</div>
                <div id="coins-count" class="card-value">0</div>
                <div style="font-size: 0.75rem; margin-top: 0.5rem; color: var(--text-muted);">Scan Institutional</div>
            </div>
        </div>

        <!-- Fila 3: Configuración y Control -->
        <div class="grid">
            <div class="card">
                <div class="card-title">Configuración de Trading</div>
                <div class="config-form">
                    <div class="form-group">
                        <label>Monto por Operación (USDT)</label>
                        <input type="number" id="cfg-monto" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Apalancamiento</label>
                        <input type="number" id="cfg-leverage" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>EMA Rápida / Lenta</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="number" id="cfg-ema-fast" placeholder="8">
                            <input type="number" id="cfg-ema-slow" placeholder="21">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>RSI Periodo</label>
                        <input type="number" id="cfg-rsi" placeholder="14">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="saveConfig()">GUARDAR CAMBIOS</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title">Modo de Operación</div>
                <div class="mode-selector">
                    <div id="mode-display" class="mode-status mode-demo">MODO DEMO (TESTNET)</div>
                    <button class="btn btn-warning" style="width: 100%; margin-top: 1rem;"
                        onclick="toggleMode()">CAMBIAR A REAL / DEMO</button>
                </div>
                <div style="margin-top: 2rem;">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;"
                        onclick="startBot()">INICIAR BOT</button>
                    <button class="btn btn-danger" style="width: 100%;" onclick="stopBot()">DETENER BOT</button>
                </div>
            </div>
        </div>

        <!-- Fila 4: Posiciones Abiertas -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-title">Posiciones Abiertas</div>
            <div class="table-container">
                <table id="positions-table">
                    <thead>
                        <tr>
                            <th>Símbolo</th>
                            <th>Lado</th>
                            <th>Tamaño</th>
                            <th>Precio Entrada</th>
                            <th>PnL</th>
                        </tr>
                    </thead>
                    <tbody id="positions-body">
                        <!-- Se llena dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Fila 5: Historial de Operaciones Cerradas -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-title">Historial de Operaciones Cerradas</div>
            <div class="table-container">
                <table id="closed-trades-table">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Símbolo</th>
                            <th>Lado</th>
                            <th>PnL Realizado</th>
                        </tr>
                    </thead>
                    <tbody id="closed-trades-body">
                        <!-- Se llena dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Fila 6: Logs -->
        <div class="card" style="margin-bottom: 2rem;">
            <div class="card-title">Registro de Actividad (Logs)</div>
            <div id="logs" class="logs-container">
                <div class="log-entry log-info">Esperando inicio del sistema...</div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();

        socket.on('update_data', function (data) {
            if (data.balance) document.getElementById('balance').innerText = data.balance + ' USDT';
            if (data.total_pnl) {
                const el = document.getElementById('total-pnl');
                el.innerText = data.total_pnl + ' USDT';
                el.className = 'card-value ' + (parseFloat(data.total_pnl) >= 0 ? 'positive' : 'negative');
            }
            if (data.win_count !== undefined) {
                document.getElementById('win-count').innerText = data.win_count + ' W';
                updateWinRate(data.win_count, data.loss_count);
            }
            if (data.loss_count !== undefined) {
                document.getElementById('loss-count').innerText = data.loss_count + ' L';
                updateWinRate(data.win_count, data.loss_count);
            }
            if (data.points !== undefined) document.getElementById('learning-points').innerText = data.points;
            if (data.coins_count !== undefined) document.getElementById('coins-count').innerText = data.coins_count;

            if (data.btc_trend) {
                const el = document.getElementById('btc-trend');
                el.innerText = data.btc_trend;
                el.className = 'card-value ' + (data.btc_trend.includes('ALCISTA') ? 'positive' : (data.btc_trend.includes('BAJISTA') ? 'negative' : ''));
            }

            if (data.positions) updatePositionsTable(data.positions);
            if (data.closed_trades) updateClosedTradesTable(data.closed_trades);
        });

        function updateWinRate(w, l) {
            const total = w + l;
            const rate = total > 0 ? ((w / total) * 100).toFixed(1) : 0;
            document.getElementById('win-rate').innerText = rate + '%';
        }

        socket.on('new_log', function (data) {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (data.type || 'log-info');
            entry.innerText = `[${new Date().toLocaleTimeString()}] ${data.message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        });

        function updatePositionsTable(positions) {
            const body = document.getElementById('positions-body');
            body.innerHTML = '';
            if (positions.length === 0) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#64748b;">No hay posiciones abiertas</td></tr>';
                return;
            }
            positions.forEach(p => {
                const pnl = parseFloat(p.unrealisedPnl || 0);
                const row = `<tr>
                    <td>${p.symbol}</td>
                    <td class="${p.side === 'Buy' ? 'positive' : 'negative'}">${p.side === 'Buy' ? 'LONG' : 'SHORT'}</td>
                    <td>${p.size}</td>
                    <td>${p.avgPrice}</td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">${pnl.toFixed(2)} USDT</td>
                </tr>`;
                body.innerHTML += row;
            });
        }

        function updateClosedTradesTable(trades) {
            const body = document.getElementById('closed-trades-body');
            body.innerHTML = '';
            if (trades.length === 0) {
                body.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#64748b;">No hay operaciones cerradas</td></tr>';
                return;
            }
            trades.forEach(t => {
                const pnl = parseFloat(t.pnl);
                const row = `<tr>
                    <td>${t.time}</td>
                    <td>${t.symbol}</td>
                    <td class="${t.side === 'Buy' ? 'positive' : 'negative'}">${t.side === 'Buy' ? 'LONG' : 'SHORT'}</td>
                    <td class="${pnl >= 0 ? 'positive' : 'negative'}">${pnl.toFixed(2)} USDT</td>
                </tr>`;
                body.innerHTML += row;
            });
        }

        function startBot() {
            fetch('/start').then(r => console.log('Bot iniciado'));
        }

        function stopBot() {
            fetch('/stop').then(r => console.log('Bot detenido'));
        }

        function loadConfig() {
            fetch('/config').then(r => r.json()).then(config => {
                document.getElementById('cfg-monto').value = config.trading.monto_por_operacion;
                document.getElementById('cfg-leverage').value = config.trading.apalancamiento;
                document.getElementById('cfg-ema-fast').value = config.estrategia.ema_rapida;
                document.getElementById('cfg-ema-slow').value = config.estrategia.ema_lenta;
                document.getElementById('cfg-rsi').value = config.estrategia.rsi_periodo;
                updateModeUI(config.trading.testnet);
            });
        }

        function saveConfig() {
            const monto = parseFloat(document.getElementById('cfg-monto').value);
            const leverage = parseInt(document.getElementById('cfg-leverage').value);
            const ema_fast = parseInt(document.getElementById('cfg-ema-fast').value);
            const ema_slow = parseInt(document.getElementById('cfg-ema-slow').value);
            const rsi = parseInt(document.getElementById('cfg-rsi').value);

            fetch('/config').then(r => r.json()).then(config => {
                config.trading.monto_por_operacion = monto;
                config.trading.apalancamiento = leverage;
                config.estrategia.ema_rapida = ema_fast;
                config.estrategia.ema_lenta = ema_slow;
                config.estrategia.rsi_periodo = rsi;

                fetch('/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                }).then(() => alert('Configuración guardada. Reinicia el bot para aplicar.'));
            });
        }

        function toggleMode() {
            if (confirm('¿Estás seguro de cambiar el modo? Esto afectará a las próximas operaciones.')) {
                fetch('/toggle_mode').then(r => r.json()).then(data => {
                    updateModeUI(data.testnet);
                });
            }
        }

        function updateModeUI(isTestnet) {
            const el = document.getElementById('mode-display');
            if (isTestnet) {
                el.innerText = 'MODO DEMO (TESTNET)';
                el.className = 'mode-status mode-demo';
            } else {
                el.innerText = 'MODO REAL (MAINNET)';
                el.className = 'mode-status mode-real';
            }
        }

        loadConfig();
    </script>
</body>

</html>